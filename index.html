<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a3a5f; 
            --secondary-color: #0d2341; 
            --accent-color: #00a8cc; 
            --present-color: #28a745; 
            --overtime-color: #17a2b8; 
            --absent-color: #dc3545; 
            --vacation-color: #ffc107; 
            --sick-color: #6f42c1; 
            --offday-color: #fd7e14; 
            --weeklyoff-color: #20c997; 
            --emergency-color: #e83e8c; 
            --unfilled-color: #e9ecef; 
            --current-day-color: #fff3cd; 
            --bg-light: #f8f9fa; 
            --bg-white: #ffffff; 
            --text-dark: #212529; 
            --text-muted: #6c757d; 
            --border-color: #dee2e6; 
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); 
            --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); 
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6; }
        
        /* Container */
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: var(--shadow-md); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; margin: 0; }
        .header-info { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        #liveClock { font-size: 1.2em; font-weight: bold; font-family: 'Courier New', monospace; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 4px; }
        .month-selector { display: flex; align-items: center; gap: 10px; background-color: rgba(255, 255, 255, 0.1); padding: 8px 15px; border-radius: 8px; }
        .month-selector select { padding: 8px; border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.3); background-color: var(--bg-white); color: var(--text-dark); font-weight: 500; cursor: pointer; }

        /* Stats Dashboard */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-white); padding: 20px; border-radius: 10px; box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 15px; transition: var(--transition); }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; }
        .stat-info h3 { font-size: 14px; color: var(--text-muted); margin-bottom: 5px; font-weight: 600; }
        .stat-info p { font-size: 20px; font-weight: 700; color: var(--text-dark); margin: 0; }

        /* Action Buttons */
        .actions { display: flex; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: var(--transition); display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-sm); }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: #0086a3; transform: translateY(-2px); }
        .btn-secondary { background-color: var(--bg-white); color: var(--primary-color); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--bg-light); }
        .btn-danger { background-color: var(--emergency-color); color: white; }
        .btn-danger:hover { background-color: #d63071; transform: translateY(-2px); }
        .btn.active { box-shadow: inset 0 3px 5px rgba(0,0,0,0.125); opacity: 0.8; border: 2px solid white; }

        /* Legend */
        .legend { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background-color: var(--bg-white); border-radius: 8px; box-shadow: var(--shadow-sm); font-size: 13px; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }

        /* Table */
        .table-container { overflow-x: auto; background-color: var(--bg-white); border-radius: 12px; box-shadow: var(--shadow-md); position: relative; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 10px; text-align: center; border: 1px solid var(--border-color); font-size: 13px; white-space: nowrap; }
        th { background-color: var(--bg-light); font-weight: 700; color: var(--primary-color); position: sticky; top: 0; z-index: 10; height: 50px; }
        /* Sticky First Column (Employee Name) on the LEFT for LTR */
        th:first-child, td:first-child { text-align: left; position: sticky; left: 0; z-index: 15; background-color: var(--bg-white); font-weight: 600; min-width: 140px; border-right: 2px solid var(--border-color); }
        thead th:first-child { z-index: 20; } 

        .day-header { min-width: 38px; cursor: default; }
        .current-day { background-color: var(--current-day-color) !important; border: 2px solid var(--accent-color) !important; font-weight: 900; color: #856404; }

        .status-cell { cursor: pointer; transition: var(--transition); position: relative; font-weight: bold; font-size: 12px; min-width: 38px; }
        .status-cell:hover { transform: scale(1.1); z-index: 25; box-shadow: 0 0 8px rgba(0,0,0,0.2); }
        
        /* Status Colors */
        .status-unfilled { background-color: var(--unfilled-color); color: var(--text-muted); }
        .status-present { background-color: var(--present-color); color: white; }
        .status-overtime { background-color: var(--overtime-color); color: white; }
        .status-absent { background-color: var(--absent-color); color: white; }
        .status-vacation { background-color: var(--vacation-color); color: var(--text-dark); }
        .status-sick { background-color: var(--sick-color); color: white; }
        .status-offday { background-color: var(--offday-color); color: white; }
        .status-weeklyoff { background-color: var(--weeklyoff-color); color: white; cursor: default; }
        .status-emergency { background-color: var(--emergency-color); color: white; }

        .status-sick.has-certificate::after { content: 'ðŸ“Ž'; position: absolute; top: -4px; right: -4px; font-size: 10px; background: white; border-radius: 50%; padding: 2px; }
        
        .total-row { background-color: #e2e6ea; font-weight: 800; }
        .total-row td { color: var(--primary-color); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--bg-white); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-md); animation: slideIn 0.3s ease; position: relative; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--bg-light); padding-bottom: 10px; }
        .modal-header h2 { font-size: 20px; color: var(--primary-color); margin: 0; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .close-btn:hover { color: var(--absent-color); transform: rotate(90deg); }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: var(--text-dark); }
        .form-group select, .form-group input[type="date"], .form-group input[type="number"], .form-group input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; transition: var(--transition); }
        .form-group input:focus, .form-group select:focus { border-color: var(--accent-color); outline: none; box-shadow: 0 0 0 3px rgba(0, 168, 204, 0.2); }
        .form-group input:disabled { background-color: var(--bg-light); cursor: not-allowed; }
        
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid var(--bg-light); padding-top: 15px; }
        
        .file-upload-wrapper { position: relative; width: 100%; }
        .file-upload-wrapper input[type=file] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-upload-label { display: block; padding: 10px; border: 1px dashed var(--border-color); border-radius: 6px; text-align: center; cursor: pointer; color: var(--text-muted); font-size: 13px; transition: 0.2s; }
        .file-upload-label:hover { border-color: var(--accent-color); color: var(--accent-color); background: #f0fbfc; }

        /* Notifications */
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background-color: var(--present-color); color: white; padding: 12px 25px; border-radius: 50px; box-shadow: var(--shadow-md); z-index: 2000; font-weight: 600; transition: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); opacity: 0; pointer-events: none; }
        .notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .notification.error { background-color: var(--absent-color); }

        /* Report/Print */
        .report-modal-content { max-width: 900px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .report-table th { background-color: var(--primary-color); color: white; }
        .report-table td, .report-table th { padding: 8px; border: 1px solid #ddd; }

        @media print {
            body * { visibility: hidden; }
            .report-modal-content, .report-modal-content * { visibility: visible; }
            .report-modal-content { position: absolute; left: 0; top: 0; width: 100%; height: auto; padding: 0; margin: 0; box-shadow: none; }
            .no-print { display: none !important; }
            .modal { display: block; position: static; background: none; backdrop-filter: none; }
        }
        
        /* Weekly Off Table */
        .schedule-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; }
        .schedule-table th, .schedule-table td { border: 1px solid var(--border-color); padding: 6px; text-align: center; }
        .schedule-table select { width: 100%; padding: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-users-cog"></i> Attendance Management System</h1>
                <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Data is automatically saved to your browser (LocalStorage).</p>
            </div>
            <div class="header-info">
                <div id="liveClock">00:00:00</div>
                <div class="month-selector">
                    <label for="monthSelect" style="font-size: 13px; margin-right:5px;">Date:</label>
                    <select id="monthSelect"></select>
                    <select id="yearSelect"></select>
                </div>
            </div>
        </header>

        <!-- Stats Dashboard -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: var(--present-color);"><i class="fas fa-user-check"></i></div>
                <div class="stat-info"><h3>Present Today</h3><p id="presentCount">0</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: var(--absent-color);"><i class="fas fa-user-times"></i></div>
                <div class="stat-info"><h3>Absent Today</h3><p id="absentCount">0</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: var(--vacation-color);"><i class="fas fa-plane"></i></div>
                <div class="stat-info"><h3>On Vacation</h3><p id="vacationCount">0</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: var(--sick-color);"><i class="fas fa-user-injured"></i></div>
                <div class="stat-info"><h3>Sick Leave</h3><p id="sickCount">0</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: var(--emergency-color);"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-info"><h3>Emergency</h3><p id="emergencyCount">0</p></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
            <button class="btn btn-danger" id="emergencyModeBtn"><i class="fas fa-bolt"></i> Emergency Mode (Range)</button>
            <button class="btn btn-primary" id="addEmployeeBtn"><i class="fas fa-user-plus"></i> Add Employee</button>
            <button class="btn btn-secondary" id="weeklyOffBtn"><i class="fas fa-calendar-week"></i> Weekly Off Schedule</button>
            <button class="btn btn-primary" id="reportBtn"><i class="fas fa-file-pdf"></i> Monthly Report</button>
            <button class="btn btn-secondary" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item"><div class="legend-color status-unfilled"></div><span>Empty</span></div>
            <div class="legend-item"><div class="legend-color status-present"></div><span>Present (9h)</span></div>
            <div class="legend-item"><div class="legend-color status-overtime"></div><span>Overtime (>9h)</span></div>
            <div class="legend-item"><div class="legend-color status-absent"></div><span>Absent (0h)</span></div>
            <div class="legend-item"><div class="legend-color status-vacation"></div><span>Vacation (V)</span></div>
            <div class="legend-item"><div class="legend-color status-sick"></div><span>Sick (S)</span></div>
            <div class="legend-item"><div class="legend-color status-weeklyoff"></div><span>Weekly Off (W)</span></div>
            <div class="legend-item"><div class="legend-color status-emergency"></div><span>Emergency (E)</span></div>
        </div>

        <!-- Main Table -->
        <div class="table-container">
            <table id="mainTable">
                <thead>
                    <tr id="tableHeaderRow">
                        <th>Employee Name</th>
                        <!-- Days added via JS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows added via JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Attendance Edit Modal -->
    <div class="modal" id="attendanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Update Attendance</h2>
                <button class="close-btn" data-close="attendanceModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Employee</label>
                <input type="text" id="modalEmployeeName" disabled style="background-color: #f1f1f1;">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="text" id="modalDate" disabled style="background-color: #f1f1f1;">
            </div>
            <div class="form-group">
                <label for="statusSelect">Status</label>
                <select id="statusSelect">
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="vacation">Vacation</option>
                    <option value="sick">Sick Leave</option>
                    <option value="emergency">Emergency</option>
                    <option value="weeklyoff">Weekly Off</option>
                    <option value="offday">Official Off Day</option>
                </select>
            </div>
            <div class="form-group" id="hoursGroup">
                <label for="hoursInput">Work Hours</label>
                <input type="number" id="hoursInput" min="0" max="24" step="0.5" value="9">
            </div>
            <div class="form-group" id="certGroup" style="display: none;">
                <label>Medical Certificate (Optional)</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="certInput" accept=".pdf,.jpg,.jpeg,.png">
                    <label for="certInput" class="file-upload-label"><i class="fas fa-cloud-upload-alt"></i> Click to upload certificate</label>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" data-close="attendanceModal">Cancel</button>
                <button class="btn btn-primary" id="saveAttendanceBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Employee</h2>
                <button class="close-btn" data-close="employeeModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newEmpName">Employee Name</label>
                <input type="text" id="newEmpName" placeholder="Enter full name">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" data-close="employeeModal">Cancel</button>
                <button class="btn btn-primary" id="addEmpConfirmBtn">Add</button>
            </div>
        </div>
    </div>

    <!-- Weekly Off Schedule Modal -->
    <div class="modal" id="weeklyOffModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Weekly Off Schedule</h2>
                <button class="close-btn" data-close="weeklyOffModal">&times;</button>
            </div>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Select the weekly off day for each employee for each week. Select "None" for no assigned day off.</p>
            <div style="overflow-x: auto;">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Week 1</th>
                            <th>Week 2</th>
                            <th>Week 3</th>
                            <th>Week 4</th>
                            <th>Week 5</th>
                        </tr>
                    </thead>
                    <tbody id="weeklyOffBody"></tbody>
                </table>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" data-close="weeklyOffModal">Cancel</button>
                <button class="btn btn-primary" id="saveWeeklyOffBtn">Save & Apply</button>
            </div>
        </div>
    </div>

    <!-- Emergency Confirm Modal -->
    <div class="modal" id="emergencyConfirmModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="justify-content: center; border: none;">
                <h2 style="color: var(--emergency-color);">Confirm Emergency</h2>
            </div>
            <p id="emergencyText" style="margin-bottom: 20px;"></p>
            <div class="form-actions" style="justify-content: center;">
                <button class="btn btn-secondary" data-close="emergencyConfirmModal">Back</button>
                <button class="btn btn-danger" id="confirmEmergencyBtn">Confirm & Apply</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content report-modal-content">
            <div class="modal-header no-print">
                <h2>Monthly Attendance Report</h2>
                <button class="close-btn" data-close="reportModal">&times;</button>
            </div>
            <div id="reportContent">
                <!-- Report generated via JS -->
            </div>
            <div class="form-actions no-print">
                <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="notification" id="notification">Saved Successfully!</div>

    <script>
        // --- 1. Initial Data Setup ---
        const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        
        let employees = [
            { id: 1, name: "AHMED KENAWY" },
            { id: 2, name: "Asmita Sapkota" },
            { id: 3, name: "NONA Rose" },
            { id: 4, name: "Melvin Compendio" },
            { id: 5, name: "Manju Ranabhat" },
            { id: 6, name: "SALEH EMAD" },
            { id: 7, name: "NIRJALA MAHRJAN" },
            { id: 8, name: "HANA" }
        ];

        // Data Structure: { "2025-0": { 1: { status: 'present', hours: 9, ... }, ... } }
        let attendanceData = {}; 
        let weeklyOffSchedule = {}; 

        // Emergency Mode State
        let emergencyMode = false;
        let emergencyRange = { empId: null, start: null, end: null };
        
        // Current Edit Context
        let currentEdit = { empId: null, day: null };

        // --- 2. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initSelectors();
            loadAllData();
            setupEventListeners();
            startClock();
            renderTable();
            updateStats();
        });

        function initSelectors() {
            const mSelect = document.getElementById('monthSelect');
            const ySelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();

            months.forEach((m, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = m;
                if(idx === new Date().getMonth()) opt.selected = true;
                mSelect.appendChild(opt);
            });

            for(let i = currentYear; i <= currentYear + 2; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                ySelect.appendChild(opt);
            }
        }

        function getStorageKey() {
            const m = document.getElementById('monthSelect').value;
            const y = document.getElementById('yearSelect').value;
            return `attendance_${y}_${m}`;
        }

        function loadAllData() {
            const key = getStorageKey();
            const stored = localStorage.getItem(key);
            if(stored) {
                attendanceData = JSON.parse(stored);
            } else {
                attendanceData = {};
            }

            const scheduleStored = localStorage.getItem('weeklyOffSchedule');
            if(scheduleStored) {
                weeklyOffSchedule = JSON.parse(scheduleStored);
            } else {
                // Initialize empty schedule
                employees.forEach(e => weeklyOffSchedule[e.id] = [null, null, null, null, null]);
            }
        }

        // --- 3. Rendering the Table ---
        function renderTable() {
            const m = parseInt(document.getElementById('monthSelect').value);
            const y = parseInt(document.getElementById('yearSelect').value);
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const today = new Date();

            const thead = document.querySelector('#tableHeaderRow');
            const tbody = document.getElementById('tableBody');
            
            // Build Table Header
            thead.innerHTML = '<th>Employee Name</th>';
            for(let i=1; i<=daysInMonth; i++) {
                const th = document.createElement('th');
                th.textContent = i;
                th.className = 'day-header';
                // Highlight Current Day
                if(i === today.getDate() && m === today.getMonth() && y === today.getFullYear()) {
                    th.classList.add('current-day');
                }
                thead.appendChild(th);
            }
            // Total Columns
            const totalHeader = document.createElement('th');
            totalHeader.textContent = 'Days Worked';
            thead.appendChild(totalHeader);
            const otHeader = document.createElement('th');
            otHeader.textContent = 'Total OT Hrs';
            thead.appendChild(otHeader);

            // Build Table Body
            tbody.innerHTML = '';
            
            employees.forEach(emp => {
                const tr = document.createElement('tr');
                
                // Employee Name
                const nameTd = document.createElement('td');
                nameTd.textContent = emp.name;
                nameTd.style.fontWeight = "bold";
                tr.appendChild(nameTd);

                let workedDays = 0;
                let totalOT = 0;

                // Day Cells
                for(let day=1; day<=daysInMonth; day++) {
                    const td = document.createElement('td');
                    const entry = attendanceData[emp.id] ? attendanceData[emp.id][day] : null;
                    
                    if(entry) {
                        td.className = `status-cell status-${entry.status}`;
                        
                        if(entry.status === 'present' || entry.status === 'overtime') {
                            td.textContent = entry.hours;
                            workedDays++;
                            if(entry.hours > 9) totalOT += (entry.hours - 9);
                            if(entry.hours > 9) td.classList.replace('status-present', 'status-overtime');
                        } else if (entry.status === 'absent') {
                            td.textContent = '0';
                        } else {
                            // Status Initial
                            let char = entry.status.charAt(0).toUpperCase();
                            if(entry.status === 'weeklyoff') char = 'W';
                            if(entry.status === 'emergency') char = 'E';
                            td.textContent = char;
                        }

                        if(entry.certificate) td.classList.add('has-certificate');
                    } else {
                        // Check for Auto Weekly Off
                        const weekNum = Math.ceil(day / 7);
                        const schedule = weeklyOffSchedule[emp.id] || [];
                        const offDayIndex = schedule[weekNum - 1]; // 0 = Sun, 6 = Sat
                        
                        const dateObj = new Date(y, m, day);
                        const dayOfWeek = dateObj.getDay();

                        if(offDayIndex !== null && offDayIndex === dayOfWeek) {
                            td.className = 'status-cell status-weeklyoff';
                            td.textContent = 'W';
                            td.title = 'Weekly Off (Auto)';
                        } else {
                            td.className = 'status-cell status-unfilled';
                            td.textContent = '-';
                        }
                    }

                    // Highlight Current Day
                    if(day === today.getDate() && m === today.getMonth() && y === today.getFullYear()) {
                        td.style.border = "2px solid var(--accent-color)";
                    }

                    // Click Event
                    td.onclick = (e) => handleCellClick(e, emp.id, day, td);
                    
                    tr.appendChild(td);
                }

                // Total Cells
                const totalTd = document.createElement('td');
                totalTd.textContent = workedDays;
                totalTd.style.fontWeight = "bold";
                tr.appendChild(totalTd);

                const otTd = document.createElement('td');
                otTd.textContent = totalOT.toFixed(1);
                otTd.style.color = "var(--overtime-color)";
                otTd.style.fontWeight = "bold";
                tr.appendChild(otTd);

                tbody.appendChild(tr);
            });
            
            updateStats();
        }

        function updateStats() {
            const m = parseInt(document.getElementById('monthSelect').value);
            const y = parseInt(document.getElementById('yearSelect').value);
            const today = new Date();
            const currentDay = today.getDate();
            
            const isCurrentMonth = (m === today.getMonth() && y === today.getFullYear());
            
            let counts = { present: 0, absent: 0, vacation: 0, sick: 0, emergency: 0 };

            employees.forEach(emp => {
                if(isCurrentMonth) {
                    const entry = attendanceData[emp.id] ? attendanceData[emp.id][currentDay] : null;
                    if(entry) {
                        if(entry.status === 'present' || entry.status === 'overtime') counts.present++;
                        else if(entry.status === 'absent') counts.absent++;
                        else if(entry.status === 'vacation') counts.vacation++;
                        else if(entry.status === 'sick') counts.sick++;
                        else if(entry.status === 'emergency') counts.emergency++;
                    }
                }
            });

            document.getElementById('presentCount').textContent = counts.present;
            document.getElementById('absentCount').textContent = counts.absent;
            document.getElementById('vacationCount').textContent = counts.vacation;
            document.getElementById('sickCount').textContent = counts.sick;
            document.getElementById('emergencyCount').textContent = counts.emergency;
        }

        // --- 4. Interactions ---
        function handleCellClick(e, empId, day, tdElement) {
            if(emergencyMode) {
                handleEmergencySelection(empId, day);
                return;
            }

            // Open Edit Modal
            currentEdit = { empId, day };
            const emp = employees.find(e => e.id === empId);
            const m = document.getElementById('monthSelect').value;
            const y = document.getElementById('yearSelect').value;
            
            document.getElementById('modalEmployeeName').value = emp.name;
            document.getElementById('modalDate').value = `${day} ${months[m]} ${y}`;
            
            // Fill current data
            const entry = attendanceData[empId] ? attendanceData[empId][day] : null;
            
            const statusSelect = document.getElementById('statusSelect');
            const hoursInput = document.getElementById('hoursInput');
            const certGroup = document.getElementById('certGroup');

            if(entry) {
                statusSelect.value = entry.status;
                hoursInput.value = entry.hours || 0;
                certGroup.style.display = (entry.status === 'sick') ? 'block' : 'none';
                hoursInput.disabled = (entry.status !== 'present' && entry.status !== 'overtime');
            } else {
                statusSelect.value = 'present';
                hoursInput.value = 9;
                hoursInput.disabled = false;
                certGroup.style.display = 'none';
            }

            openModal('attendanceModal');
        }

        function handleEmergencySelection(empId, day) {
            if(!emergencyRange.empId) {
                // Start Selection
                emergencyRange = { empId, start: day, end: day };
                showNotification('Start date selected. Please select the end date.');
            } else if (emergencyRange.empId === empId) {
                // End Selection (Same Employee)
                emergencyRange.end = day;
                showEmergencyConfirm();
            } else {
                // Different Employee - Reset
                emergencyRange = { empId, start: day, end: day };
                showNotification('Employee changed. Please select the end date for this employee.');
            }
        }

        function showEmergencyConfirm() {
            const emp = employees.find(e => e.id === emergencyRange.empId);
            const start = emergencyRange.start;
            const end = emergencyRange.end;
            const min = Math.min(start, end);
            const max = Math.max(start, end);
            
            const text = `Are you sure you want to mark Emergency Leave for <b>${emp.name}</b><br>from day ${min} to day ${max}?`;
            
            document.getElementById('emergencyText').innerHTML = text;
            openModal('emergencyConfirmModal');
        }

        // --- 5. Saving ---
        document.getElementById('saveAttendanceBtn').addEventListener('click', () => {
            const status = document.getElementById('statusSelect').value;
            let hours = parseFloat(document.getElementById('hoursInput').value);
            
            if(status !== 'present' && status !== 'overtime') hours = 0;
            if(status === 'overtime' && hours <= 9) hours = 9.5; 

            if(!attendanceData[currentEdit.empId]) attendanceData[currentEdit.empId] = {};
            
            attendanceData[currentEdit.empId][currentEdit.day] = {
                status: status,
                hours: hours,
                certificate: null 
            };

            saveToStorage();
            renderTable();
            closeModal('attendanceModal');
            showNotification('Record updated successfully');
        });

        document.getElementById('confirmEmergencyBtn').addEventListener('click', () => {
            const { empId, start, end } = emergencyRange;
            const min = Math.min(start, end);
            const max = Math.max(start, end);

            if(!attendanceData[empId]) attendanceData[empId] = {};

            for(let d = min; d <= max; d++) {
                attendanceData[empId][d] = {
                    status: 'emergency',
                    hours: 0,
                    certificate: null
                };
            }

            saveToStorage();
            renderTable();
            closeModal('emergencyConfirmModal');
            toggleEmergencyMode(); 
            showNotification('Emergency leave recorded for selected range');
        });

        function saveToStorage() {
            localStorage.setItem(getStorageKey(), JSON.stringify(attendanceData));
        }

        // --- 6. Employee & Weekly Off Management ---
        document.getElementById('addEmpConfirmBtn').addEventListener('click', () => {
            const name = document.getElementById('newEmpName').value.trim();
            if(name) {
                const newId = employees.length > 0 ? Math.max(...employees.map(e => e.id)) + 1 : 1;
                employees.push({ id: newId, name: name });
                weeklyOffSchedule[newId] = [null, null, null, null, null];
                
                renderTable();
                renderWeeklyOffTable(); 
                closeModal('employeeModal');
                document.getElementById('newEmpName').value = '';
                showNotification('Employee added successfully');
            }
        });

        const weekDaysOptions = `
            <option value="-1">None</option>
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
        `;

        function renderWeeklyOffTable() {
            const tbody = document.getElementById('weeklyOffBody');
            tbody.innerHTML = '';
            employees.forEach(emp => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = emp.name;
                tr.appendChild(nameTd);

                const schedule = weeklyOffSchedule[emp.id] || [null,null,null,null,null];
                
                schedule.forEach((dayVal, idx) => {
                    const td = document.createElement('td');
                    const select = document.createElement('select');
                    select.innerHTML = weekDaysOptions;
                    select.value = dayVal === null ? -1 : dayVal;
                    select.dataset.empId = emp.id;
                    select.dataset.weekIdx = idx;
                    td.appendChild(select);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        document.getElementById('weeklyOffBtn').addEventListener('click', () => {
            renderWeeklyOffTable();
            openModal('weeklyOffModal');
        });

        document.getElementById('saveWeeklyOffBtn').addEventListener('click', () => {
            const selects = document.querySelectorAll('#weeklyOffBody select');
            selects.forEach(sel => {
                const empId = parseInt(sel.dataset.empId);
                const wIdx = parseInt(sel.dataset.weekIdx);
                const val = parseInt(sel.value);
                weeklyOffSchedule[empId][wIdx] = (val === -1) ? null : val;
            });
            localStorage.setItem('weeklyOffSchedule', JSON.stringify(weeklyOffSchedule));
            closeModal('weeklyOffModal');
            renderTable();
            showNotification('Weekly off schedule saved');
        });

        // --- 7. Reporting ---
        document.getElementById('reportBtn').addEventListener('click', generateReport);

        function generateReport() {
            const m = parseInt(document.getElementById('monthSelect').value);
            const y = parseInt(document.getElementById('yearSelect').value);
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            let html = `
                <div style="text-align:center; margin-bottom:20px;">
                    <h2>Monthly Attendance Report</h2>
                    <p>For ${months[m]} - ${y}</p>
                </div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>Days Worked</th>
                            <th>Total Hours</th>
                            <th>Overtime (OT)</th>
                            <th>Absences</th>
                            <th>Leaves</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            employees.forEach(emp => {
                let workedDays = 0, totalHours = 0, totalOT = 0, absentDays = 0, vacationDays = 0;
                let entry = attendanceData[emp.id];

                if(entry) {
                    for(let d=1; d<=daysInMonth; d++) {
                        if(entry[d]) {
                            const s = entry[d].status;
                            if(s === 'present' || s === 'overtime') {
                                workedDays++;
                                totalHours += entry[d].hours;
                                if(entry[d].hours > 9) totalOT += (entry[d].hours - 9);
                            } else if(s === 'absent') {
                                absentDays++;
                            } else if(s === 'vacation' || s === 'sick' || s === 'emergency' || s === 'offday' || s === 'weeklyoff') {
                                vacationDays++;
                            }
                        }
                    }
                }

                html += `
                    <tr>
                        <td style="text-align:left">${emp.name}</td>
                        <td>${workedDays}</td>
                        <td>${totalHours.toFixed(1)}</td>
                        <td>${totalOT.toFixed(1)}</td>
                        <td style="color:var(--absent-color)">${absentDays}</td>
                        <td>${vacationDays}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            document.getElementById('reportContent').innerHTML = html;
            openModal('reportModal');
        }

        // --- 8. Helpers ---
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function toggleEmergencyMode() {
            emergencyMode = !emergencyMode;
            const btn = document.getElementById('emergencyModeBtn');
            if(emergencyMode) {
                btn.classList.add('active');
                emergencyRange = { empId: null, start: null, end: null };
                showNotification('Emergency Mode Active: Select Employee, then Start and End dates');
                document.body.style.cursor = "crosshair";
            } else {
                btn.classList.remove('active');
                emergencyRange = { empId: null, start: null, end: null };
                document.body.style.cursor = "default";
            }
        }

        function showNotification(msg, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = msg;
            el.className = `notification ${type}`;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('liveClock').textContent = now.toLocaleTimeString('en-US', {hour12: false});
            };
            setInterval(update, 1000);
            update();
        }

        function setupEventListeners() {
            // Close Modals
            document.querySelectorAll('[data-close]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.dataset.close);
                });
            });

            // General Buttons
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadAllData();
                renderTable();
                showNotification('Data Refreshed');
            });

            document.getElementById('emergencyModeBtn').addEventListener('click', toggleEmergencyMode);
            document.getElementById('addEmployeeBtn').addEventListener('click', () => openModal('employeeModal'));
            
            // Date Selectors
            ['monthSelect', 'yearSelect'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    loadAllData();
                    renderTable();
                });
            });

            // Modal Field Logic
            document.getElementById('statusSelect').addEventListener('change', (e) => {
                const status = e.target.value;
                const hoursGroup = document.getElementById('hoursGroup');
                const certGroup = document.getElementById('certGroup');
                
                if(status === 'present' || status === 'overtime') {
                    hoursGroup.style.display = 'block';
                    document.getElementById('hoursInput').disabled = false;
                } else {
                    hoursGroup.style.display = 'none';
                    document.getElementById('hoursInput').disabled = true;
                }

                if(status === 'sick') {
                    certGroup.style.display = 'block';
                } else {
                    certGroup.style.display = 'none';
                }
            });
            
            // Click outside to close
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('show');
                }
            }
        }
    </script>
</body>
</html>
